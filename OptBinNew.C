#include <iostream>
#include <fstream>
//#include "PlottingHeaderUC.h"

///Checks for unfolding
void OptBinNew(int pt1, int pt2, std::string hist_name)
{

//Opt_Un_eec
//Opt_Un_e3c
    std::string fname = "/Users/ar2545/AnalysisDownloads/AnalysisResults_Data_Apr16.root";
    
    TFile *f = new TFile(fname.c_str(), "READ");
    
    //-------------------------------------------------------------------
    //    //-------------Defining strings------------------------------
    //-------------------------------------------------------------------
    const char *str = "p^{ch,det}_{T,jet}";
    const char *str3 = "#sqrt{s} = 13 TeV";
    const char *str2 = "anti-#it{k}_{T}";
    const char *str1 = "#it{p}^{ch}_{T,min}";
    const char *str4 = "#it{R}_{L}";
    const char *str5 = "#it{p}^{ch,true}_{T,jet}";
    const char *str6 = "#it{p}^{ch}_{T,jet}";
    const char *str13 = "#it{R}_{L}^{det}";
    const char *str14 = "#it{R}_{L}^{tru}";
    const char *str15 = "#it{wt}^{det}";
    const char *str16 = "#it{wt}^{tru}";
    const char *str17 = "#it{R}_{L}";
    const char *str18 = "#it{z}^{true}_{T}";
    const char *str19 = "#it{z}^{det}_{T}";
    const char *str20 = "#it{p}^{true}_{T}";
    const char *str21 = "#it{p}^{det}_{T}";
    const char *str22 = "#it{wt}^{det_nj}";
    const char *str23 = "#it{wt}^{tru_nj}";
    //-------------------------------------------------------------------
    Double_t textSizeRel = 0.04;
    TLatex latex;
    latex.SetNDC();
    latex.SetTextSize(textSizeRel);
    latex.SetTextFont(42);
    TLatex latex1;
    latex1.SetNDC();
    latex1.SetTextSize(textSizeRel);
    latex1.SetTextFont(42);
    TLatex latex2;
    latex2.SetNDC();
    latex2.SetTextSize(textSizeRel);
    latex2.SetTextFont(42);
    
    latex.SetTextColor(kBlack);
    latex2.SetTextColor(kBlack);
    //-------------------------------------------------------------------
    
    string jetpt = str6;
    string plot_title ="";
    
    TList *hList = (TList*)f->Get(Form("JetsEEC_Jet_AKTChargedR040_tracks_pT0150_E_scheme_TCRaw_Data_NoSub_Incl;1"));
    
    TCanvas *ca;
    TH3D* h_un3d= (TH3D*)hList->FindObject(hist_name.c_str());
    h_un3d->GetYaxis()->SetRange(pt1,pt2);
    float high_pt_bin = h_un3d->GetYaxis()->GetBinUpEdge(pt2);
    float low_pt_bin = h_un3d->GetYaxis()->GetBinLowEdge(pt1);
    TH2D* h_un2d= (TH2D*)h_un3d->Project3D("zx");
    h_un2d->Sumw2();
    cout<<h_un2d->GetNbinsX()<<endl;
    TCanvas *canvas = new TCanvas();
    h_un2d->Draw("text");
    
   
    Double_t from = -4;
    Double_t to = 0;
    Int_t bins = 100;
    Double_t width = (to-from)/bins;
    Double_t new_bins[101] = {};
    for (Int_t i = 0; i <= bins; i++)
    {
        new_bins[i] = TMath::Power(10.0, from + i * width);
//        cout<<new_bins[i]<<endl;
    }


    //eec weight bins
    Double_t wt_from = -4;
    Double_t wt_to = 0;
    Int_t wt_bins = 200;
    Double_t wt_width = (wt_to-wt_from)/wt_bins;
    Double_t wt_new_bins[201] = {};
    for (Int_t i = 0; i <= wt_bins; i++)
    {
        wt_new_bins[i] = TMath::Power(10.0, wt_from + i * wt_width);
    }
    
    
     //e3c weight bins
    Double_t wt_from_e3c = -6;
    Double_t wt_to_e3c = 0;
    Int_t wt_bins_e3c = 400;
    Double_t wt_width_e3c = (wt_to_e3c-wt_from_e3c)/wt_bins_e3c;
    Double_t wt_new_bins_e3c[401] = {};
    for (Int_t i = 0; i <= wt_bins_e3c; i++)
    {
        wt_new_bins_e3c[i] = TMath::Power(10.0, wt_from_e3c + i * wt_width_e3c);
    }
//------------------------------------------------------------------------------------
    double Rvalues[] = {
        0.0001, 0.000109648, 0.000120226, 0.000131826, 0.000144544,
        0.000158489, 0.00017378, 0.000190546, 0.00020893, 0.000229087,
        0.000251189, 0.000275423, 0.000301995, 0.000331131, 0.000363078,
        0.000398107, 0.000436516, 0.00047863, 0.000524807, 0.00057544,
        0.000630957, 0.000691831, 0.000758578, 0.000831764, 0.000912011,
        0.001, 0.00109648, 0.00120226, 0.00131826, 0.00144544,
        0.00158489, 0.0017378, 0.00190546, 0.0020893, 0.00229087,
        0.00251189, 0.00275423, 0.00301995, 0.00331131, 0.00363078,
        0.00398107, 0.00436516, 0.0047863, 0.00524807, 0.0057544,
        0.00630957, 0.00691831, 0.00758578, 0.00831764, 0.00912011,
        0.01, 0.0109648, 0.0120226, 0.0131826, 0.0144544,
        0.0158489, 0.017378, 0.0190546, 0.020893, 0.0229087,
        0.0251189, 0.0275423, 0.0301995, 0.0331131, 0.0363078,
        0.0398107, 0.0436516, 0.047863, 0.0524807, 0.057544,
        0.0630957, 0.0691831, 0.0758578, 0.0831764, 0.0912011,
        0.1, 0.109648, 0.120226, 0.131826, 0.144544,
        0.158489, 0.17378, 0.190546, 0.20893, 0.229087,
        0.251189, 0.275423, 0.301995, 0.331131, 0.363078,
        0.398107, 0.436516, 0.47863, 0.524807, 0.57544,
        0.630957, 0.691831, 0.758578, 0.831764, 0.912011,
        1.0
    };

//for 60-80 bin for eec
    double RvaluesReb[] = {
        0.0001,
        0.01,
        0.0158489, 0.0190546, 0.0229087,
        0.0275423, 0.0331131,
        0.0398107, 0.0436516, 0.047863, 0.0524807, 0.057544,
        0.0630957, 0.0691831, 0.0758578, 0.0831764, 0.0912011,
        0.1, 0.109648, 0.120226, 0.131826, 0.144544,
        0.158489, 0.17378, 0.190546, 0.20893, 0.229087,
        0.251189, 0.275423, 0.301995, 0.331131, 0.363078,
        0.398107, 0.524807,
        1.0
    };

    // Define the array as a constexpr to ensure compile-time constant
    constexpr double values[] = {
        0.0001, 0.000104713, 0.000109648, 0.000114815, 0.000120226, 0.000125893, 0.000131826,
        0.000138038, 0.000144544, 0.000151356, 0.000158489, 0.000165959, 0.00017378, 0.00018197,
        0.000190546, 0.000199526, 0.00020893, 0.000218776, 0.000229087, 0.000239883, 0.000251189,
        0.000263027, 0.000275423, 0.000288403, 0.000301995, 0.000316228, 0.000331131, 0.000346737,
        0.000363078, 0.000380189, 0.000398107, 0.000416869, 0.000436516, 0.000457088, 0.00047863,
        0.000501187, 0.000524807, 0.000549541, 0.00057544, 0.00060256, 0.000630957, 0.000660693,
        0.000691831, 0.000724436, 0.000758578, 0.000794328, 0.000831764, 0.000870964, 0.000912011,
        0.000954993, 0.001, 0.00104713, 0.00109648, 0.00114815, 0.00120226, 0.00125893, 0.00131826,
        0.00138038, 0.00144544, 0.00151356, 0.00158489, 0.00165959, 0.0017378, 0.0018197, 0.00190546,
        0.00199526, 0.0020893, 0.00218776, 0.00229087, 0.00239883, 0.00251189, 0.00263027, 0.00275423,
        0.00288403, 0.00301995, 0.00316228, 0.00331131, 0.00346737, 0.00363078, 0.00380189, 0.00398107,
        0.00416869, 0.00436516, 0.00457088, 0.0047863, 0.00501187, 0.00524807, 0.00549541, 0.0057544,
        0.0060256, 0.00630957, 0.00660693, 0.00691831, 0.00724436, 0.00758578, 0.00794328, 0.00831764,
        0.00870964, 0.00912011, 0.00954993, 0.01, 0.0104713, 0.0109648, 0.0114815, 0.0120226, 0.0125893,
        0.0131826, 0.0138038, 0.0144544, 0.0151356, 0.0158489, 0.0165959, 0.017378, 0.018197, 0.0190546,
        0.0199526, 0.020893, 0.0218776, 0.0229087, 0.0239883, 0.0251189, 0.0263027, 0.0275423, 0.0288403,
        0.0301995, 0.0316228, 0.0331131, 0.0346737, 0.0363078, 0.0380189, 0.0398107, 0.0416869, 0.0436516,
        0.0457088, 0.047863, 0.0501187, 0.0524807, 0.0549541, 0.057544, 0.060256, 0.0630957, 0.0660693,
        0.0691831, 0.0724436, 0.0758578, 0.0794328, 0.0831764, 0.0870964, 0.0912011, 0.0954993, 0.1,
        0.104713, 0.109648, 0.114815, 0.120226, 0.125893, 0.131826, 0.138038, 0.144544, 0.151356,
        0.158489, 0.165959, 0.17378, 0.18197, 0.190546, 0.199526, 0.20893, 0.218776, 0.229087, 0.239883,
        0.251189, 0.263027, 0.275423, 0.288403, 0.301995, 0.316228, 0.331131, 0.346737, 0.363078,
        0.380189, 0.398107, 0.416869, 0.436516, 0.457088, 0.47863, 0.501187, 0.524807, 0.549541,
        0.57544, 0.60256, 0.630957, 0.660693, 0.691831, 0.724436, 0.758578, 0.794328, 0.831764,
        0.870964, 0.912011, 0.954993, 1.0
    };
    
    constexpr double Rebvalues[] = {
        0.0001, 0.00301995, 0.00501187, 0.01, 0.0158489, 0.020893, 0.0301995, 0.0501187, 0.060256, 0.1,
        0.151356, 0.758578,1.0};

    constexpr double values_e3c[] = {
        1e-06, 1.03514e-06, 1.07152e-06, 1.10917e-06, 1.14815e-06, 1.1885e-06, 1.23027e-06, 1.2735e-06,
        1.31826e-06, 1.36458e-06, 1.41254e-06, 1.46218e-06, 1.51356e-06, 1.56675e-06, 1.62181e-06, 1.6788e-06, 
        1.7378e-06, 1.79887e-06, 1.86209e-06, 1.92752e-06, 1.99526e-06, 2.06538e-06, 2.13796e-06, 2.21309e-06, 
        2.29087e-06, 2.37137e-06, 2.45471e-06, 2.54097e-06, 2.63027e-06, 2.7227e-06, 2.81838e-06, 2.91743e-06, 
        3.01995e-06, 3.12608e-06, 3.23594e-06, 3.34965e-06, 3.46737e-06, 3.58922e-06, 3.71535e-06, 3.84592e-06, 
        3.98107e-06, 4.12098e-06, 4.2658e-06, 4.4157e-06, 4.57088e-06, 4.73151e-06, 4.89779e-06, 5.06991e-06, 
        5.24807e-06, 5.4325e-06, 5.62341e-06, 5.82103e-06, 6.0256e-06, 6.23735e-06, 6.45654e-06, 6.68344e-06, 
        6.91831e-06, 7.16143e-06, 7.4131e-06, 7.67361e-06, 7.94328e-06, 8.22243e-06, 8.51138e-06, 8.81049e-06, 
        9.12011e-06, 9.44061e-06, 9.77237e-06, 1.01158e-05, 1.04713e-05, 1.08393e-05, 1.12202e-05, 1.16145e-05, 
        1.20226e-05, 1.24451e-05, 1.28825e-05, 1.33352e-05, 1.38038e-05, 1.42889e-05, 1.47911e-05, 1.53109e-05, 
        1.58489e-05, 1.64059e-05, 1.69824e-05, 1.75792e-05, 1.8197e-05, 1.88365e-05, 1.94984e-05, 2.01837e-05, 
        2.0893e-05, 2.16272e-05, 2.23872e-05, 2.31739e-05, 2.39883e-05, 2.48313e-05, 2.5704e-05, 2.66073e-05, 
        2.75423e-05, 2.85102e-05, 2.95121e-05, 3.05492e-05, 3.16228e-05, 3.27341e-05, 3.38844e-05, 3.50752e-05, 
        3.63078e-05, 3.75837e-05, 3.89045e-05, 4.02717e-05, 4.16869e-05, 4.31519e-05, 4.46684e-05, 4.62381e-05, 
        4.7863e-05, 4.9545e-05, 5.12861e-05, 5.30884e-05, 5.49541e-05, 5.68853e-05, 5.88844e-05, 6.09537e-05, 
        6.30957e-05, 6.53131e-05, 6.76083e-05, 6.99842e-05, 7.24436e-05, 7.49894e-05, 7.76247e-05, 8.03526e-05, 
        8.31764e-05, 8.60994e-05, 8.91251e-05, 9.22571e-05, 9.54993e-05, 9.88553e-05, 0.000102329, 0.000105925, 
        0.000109648, 0.000113501, 0.00011749, 0.000121619, 0.000125893, 0.000130317, 0.000134896, 0.000139637, 
        0.000144544, 0.000149624, 0.000154882, 0.000160325, 0.000165959, 0.000171791, 0.000177828, 0.000184077, 
        0.000190546, 0.000197242, 0.000204174, 0.000211349, 0.000218776, 0.000226464, 0.000234423, 0.000242661, 
        0.000251189, 0.000260016, 0.000269153, 0.000278612, 0.000288403, 0.000298538, 0.00030903, 0.00031989, 
        0.000331131, 0.000342768, 0.000354813, 0.000367282, 0.000380189, 0.00039355, 0.00040738, 0.000421697, 
        0.000436516, 0.000451856, 0.000467735, 0.000484172, 0.000501187, 0.0005188, 0.000537032, 0.000555904, 
        0.00057544, 0.000595662, 0.000616595, 0.000638263, 0.000660693, 0.000683912, 0.000707946, 0.000732825, 
        0.000758578, 0.000785236, 0.000812831, 0.000841395, 0.000870964, 0.000901571, 0.000933254, 0.000966051, 
        0.001, 0.00103514, 0.00107152, 0.00110917, 0.00114815, 0.0011885, 0.00123027, 0.0012735, 0.00131826, 
        0.00136458, 0.00141254, 0.00146218, 0.00151356, 0.00156675, 0.00162181, 0.0016788, 0.0017378, 0.00179887, 
        0.00186209, 0.00192752, 0.00199526, 0.00206538, 0.00213796, 0.00221309, 0.00229087, 0.00237137, 0.00245471, 
        0.00254097, 0.00263027, 0.0027227, 0.00281838, 0.00291743, 0.00301995, 0.00312608, 0.00323594, 0.00334965, 
        0.00346737, 0.00358922, 0.00371535, 0.00384592, 0.00398107, 0.00412098, 0.0042658, 0.0044157, 0.00457088, 
        0.00473151, 0.00489779, 0.00506991, 0.00524807, 0.0054325, 0.00562341, 0.00582103, 0.0060256, 0.00623735, 
        0.00645654, 0.00668344, 0.00691831, 0.00716143, 0.0074131, 0.00767361, 0.00794328, 0.00822243, 0.00851138, 
        0.00881049, 0.00912011, 0.00944061, 0.00977237, 0.0101158, 0.0104713, 0.0108393, 0.0112202, 0.0116145, 
        0.0120226, 0.0124451, 0.0128825, 0.0133352, 0.0138038, 0.0142889, 0.0147911, 0.0153109, 0.0158489, 
        0.0164059, 0.0169824, 0.0175792, 0.018197, 0.0188365, 0.0194984, 0.0201837, 0.020893, 0.0216272, 0.0223872, 
        0.0231739, 0.0239883, 0.0248313, 0.025704, 0.0266073, 0.0275423, 0.0285102, 0.0295121, 0.0305492, 
        0.0316228, 0.0327341, 0.0338844, 0.0350752, 0.0363078, 0.0375837, 0.0389045, 0.0402717, 0.0416869, 
        0.0431519, 0.0446684, 0.0462381, 0.047863, 0.049545, 0.0512861, 0.0530884, 0.0549541, 0.0568853, 
        0.0588844, 0.0609537, 0.0630957, 0.0653131, 0.0676083, 0.0699842, 0.0724436, 0.0749894, 0.0776247, 
        0.0803526, 0.0831764, 0.0860994, 0.0891251, 0.0922571, 0.0954993, 0.0988553, 0.102329, 0.105925, 
        0.109648, 0.113501, 0.11749, 0.121619, 0.125893, 0.130317, 0.134896, 0.139637, 0.144544, 0.149624, 
        0.154882, 0.160325, 0.165959, 0.171791, 0.177828, 0.184077, 0.190546, 0.197242, 0.204174, 0.211349, 
        0.218776, 0.226464, 0.234423, 0.242661, 0.251189, 0.260016, 0.269153, 0.278612, 0.288403, 0.298538, 
        0.30903, 0.31989, 0.331131, 0.342768, 0.354813, 0.367282, 0.380189, 0.39355, 0.40738, 0.421697, 
        0.436516, 0.451856, 0.467735, 0.484172, 0.501187, 0.5188, 0.537032, 0.555904, 0.57544, 0.595662, 
        0.616595, 0.638263, 0.660693, 0.683912, 0.707946, 0.732825, 0.758578, 0.785236, 0.812831, 0.841395, 
        0.870964, 0.901571, 0.933254, 0.966051, 1
    };
    
    constexpr double Rebvalues_e3c[] = {
        0.000102329,
        0.00151356, 0.00301995, 0.00506991, 0.00716143, 0.00912011, 0.0153109,
        0.0231739, 0.0305492,
        0.0462381,
        0.0922571,
        0.160325,
        1.0
    };
    
    
double numbins_x = sizeof(RvaluesReb)/sizeof(RvaluesReb[0]) - 1;
double numbins_y = sizeof(Rebvalues)/sizeof(Rebvalues[0]) - 1;

double numbins_x_e3c = sizeof(RvaluesReb)/sizeof(RvaluesReb[0]) - 1;
double numbins_y_e3c = sizeof(Rebvalues_e3c)/sizeof(Rebvalues_e3c[0]) - 1;
  
cout<<numbins_y<<endl;
cout<<numbins_y_e3c<<endl;
// Define the array as a constexpr to ensure compile-time constant
//    constexpr double Rebvalues[] = {
////for 60-80 bin
//    double Rebvalues[] = {
//        0.0001,0.01, 0.0151356, 0.020893, 0.0251189,
//        0.0301995, 0.0416869,
//        0.0457088, 0.0501187, 0.1,
//        0.501187, 1.0
//    };
//// 

//      TH2D* h_un2d_reb = new TH2D("h_un2d_reb", "Rebinned 2D Histogram (Both Axes)", numbins_x, RvaluesReb, numbins_y, Rebvalues);
      
      TH2D* h_un2d_reb = new TH2D("h_un2d_reb", "Rebinned 2D Histogram (Both Axes)", numbins_x_e3c, RvaluesReb, numbins_y_e3c, Rebvalues_e3c);
      
for (int i = 1; i <= h_un2d->GetNbinsX(); ++i) {
        for (int j = 1; j <= h_un2d->GetNbinsY(); ++j) {
            double content = h_un2d->GetBinContent(i, j);
            double error = h_un2d->GetBinError(i, j);
            double x = h_un2d->GetXaxis()->GetBinCenter(i);
            double y = h_un2d->GetYaxis()->GetBinCenter(j);
            h_un2d_reb->Fill(x, y, content);
            }
        }
        
        
TCanvas *canvas1 = new TCanvas();
canvas1->SetLogx();
canvas1->SetLogy();
h_un2d_reb->SetStats(0);
h_un2d_reb->GetXaxis()->SetRangeUser(0.001,0.6);
h_un2d_reb->GetYaxis()->SetRangeUser(0.001,0.6);
h_un2d_reb->GetYaxis()->SetTitle("wt");
h_un2d_reb->GetXaxis()->SetTitle(str17);
h_un2d_reb->Draw("text");
latex1.DrawLatex(0.15,0.80 ,Form("%.1f < %s < %.1f GeV/c, E3C", low_pt_bin, str6, high_pt_bin));


Double_t from_const = 15;
            Double_t to_const = 120;
            Int_t bins_const = 21;
            Double_t width_const = (to_const-from_const)/bins_const;
            Double_t new_bins_const[22] = {};
             for (Int_t i = 0; i <= bins_const; i++)
            {
             new_bins_const[i] = (from_const + i * width_const);
            }
         
      
      TH3D* h_un3d_reb = new TH3D("h_un3d_reb_e3c", "Rebinned 2D Histogram (Both Axes)", numbins_x_e3c, RvaluesReb, bins_const, new_bins_const,numbins_y_e3c, Rebvalues_e3c);
    for (int i = 1; i <= h_un3d->GetNbinsX(); ++i) {
        for (int j = 1; j <= h_un3d->GetNbinsY(); ++j) {
            for (int k = 1; k <= h_un3d->GetNbinsZ(); ++k) {
                double content = h_un3d->GetBinContent(i, j,k);
                double error = h_un3d->GetBinError(i, j,k);
                double x = h_un3d->GetXaxis()->GetBinCenter(i);
                double y = h_un3d->GetYaxis()->GetBinCenter(j);
                double z = h_un3d->GetZaxis()->GetBinCenter(k);
                h_un3d_reb->Fill(x, y, z,content);
            }
        }
    }


std::string outputFileName = "Rebinned3D_EEC.root";
    TFile *outputFile = new TFile(outputFileName.c_str(), "RECREATE");
    if (!outputFile || outputFile->IsZombie()) {
        std::cerr << "Error creating output file: " << outputFileName << std::endl;
        f->Close();
        return;
    }
    
    outputFile->cd();
    h_un3d_reb->Write();
    
    
}

